<!DOCTYPE html>
<html lang="en"><head>
  <script>'use strict';if("embedded-kiddie.github.io"===window.location.hostname){var s=document.createElement("script");s.src="https://www.googletagmanager.com/gtag/js?id=G-DLMCZ884M2";document.head.appendChild(s);window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-DLMCZ884M2")};</script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - キャリブレーション編 | Embedded Kiddie</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - キャリブレーション編" />
<meta name="author" content="Kingsman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="組み込みエンジニア。かつては趣味でWordPressプラグインなどリリース。 興味をロボットや電子工作に転じ、ハードとソフトを再勉強する日々。" />
<meta property="og:description" content="組み込みエンジニア。かつては趣味でWordPressプラグインなどリリース。 興味をロボットや電子工作に転じ、ハードとソフトを再勉強する日々。" />
<link rel="canonical" href="https://embedded-kiddie.github.io/2024/06/22/" />
<meta property="og:url" content="https://embedded-kiddie.github.io/2024/06/22/" />
<meta property="og:site_name" content="Embedded Kiddie" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-22T19:06:03+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - キャリブレーション編" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kingsman"},"dateModified":"2024-06-22T19:06:03+09:00","datePublished":"2024-06-22T19:06:03+09:00","description":"組み込みエンジニア。かつては趣味でWordPressプラグインなどリリース。 興味をロボットや電子工作に転じ、ハードとソフトを再勉強する日々。","headline":"Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - キャリブレーション編","mainEntityOfPage":{"@type":"WebPage","@id":"https://embedded-kiddie.github.io/2024/06/22/"},"url":"https://embedded-kiddie.github.io/2024/06/22/"}</script>
<!-- End Jekyll SEO tag -->

  <style type="text/css">body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{font:400 16px/2 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}p,blockquote,pre,ul,ol,dl,figure{margin-bottom:1em}h1,h2,h3,h4,h5,h6{padding-top:1em;margin-bottom:1em;clear:both}main{display:block}img{max-width:100%;vertical-align:middle;height:auto}figure>img{display:block}figcaption{font-size:14px;max-width:230px;width:fit-content;margin-right:auto;margin-left:auto;text-align:center}ul,ol{margin-left:1em}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}.e-content h1,.e-content h2,.e-content h3,.e-content h4,.e-content h5,.e-content h6{font-weight:600}h2+h3,h3+h4,h4+h5{padding-top:0}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#707070;border-left:4px solid #d6d6d6;padding-left:.5em;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:15px;border:1px solid #d6d6d6;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (1em * 2));max-width:calc(800px - 1em*2);margin-right:auto;margin-left:auto;padding-right:1em;padding-left:1em}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (1em));max-width:calc(800px - (1em));padding-right:.5em;padding-left:.5em}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.svg-icon{width:16px;height:16px;display:inline-block;fill:#707070;padding-right:5px;vertical-align:text-top}.social-media-list li+li{padding-top:5px}table{margin-bottom:1em;width:100%;text-align:left;font-size:85%;color:#1e1e1e;border-collapse:collapse;border:1px solid #d6d6d6}table tr:nth-child(even){background-color:#f7f7f7}table th,table td{padding:.3333333333em .5em}table th{background-color:#e5e5e5;border:1px solid #c2c2c2;border-bottom-color:#b7b7b7}table td{border:1px solid #d6d6d6}h5{font-size:1em}.post-content{font-size:1.125rem}.center{text-align:center}.float-left{float:left;margin:0 .75em 0 0;padding:0 .75em 0 0;width:30%}.clear-both{clear:both}video{max-width:100%;padding:0 0 1em 0;margin:auto}a[href^=http]:not(.simple):after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQElEQVR42qXKwQkAIAxDUUdxtO6/RBQkQZvSi8I/pL4BoGw/XPkh4XigPmsUgh0626AjRsgxHTkUThsG2T/sIlzdTsp52kSS1wAAAABJRU5ErkJggg==);margin:0 3px 0 5px}figure.flex{display:flex;text-align:center;justify-content:space-around}figure.flex a{margin:0 .25em}img{margin:.5em 0 1em 0;box-shadow:0 5px 10px 0 rgba(0,0,0,.1)}img.emoji{height:1.5em;width:1.5em;margin:0 0 .25em 0;box-shadow:none}span.emoji{font-size:1.5em;line-height:1em}span.inline img{height:1.5em;margin:0;box-shadow:none}td img{margin-bottom:0}img.simple{box-shadow:none;width:100%}.twitter-tweet{padding-bottom:.5em}.quote,.notice{padding:.5em 1em;margin:1em 0 2em 0;color:#505050;background:#fff;border-radius:10px}.quote h3,.quote h4,.quote h5,.quote p:last-child,.notice h3,.notice h4,.notice h5,.notice p:last-child{margin:0;padding:0}.quote{border:solid 3px #5c81e6}.notice{border:solid 3px #e01b7e}figcaption{margin-bottom:1em}footer.site-footer div{font-size:16px !important}header h1,footer div{line-height:1.5}.pagetop{height:50px;width:50px;position:fixed;right:30px;bottom:50px;background:#fff;border:solid 2px #000;border-radius:50%;display:flex;justify-content:center;align-items:center;z-index:2;cursor:pointer;transition:all .3s;opacity:0;visibility:hidden}.pagetop_arrow{display:block;height:10px;width:10px;border-top:3px solid #000;border-right:3px solid #000;transform:translateY(20%) rotate(-45deg)}.pagetop.fadeIn{opacity:.5;visibility:inherit}.pagetop:hover{opacity:1}.pager{clear:both;margin:2em 0;border-top:1px solid #c8c8c8;border-bottom:1px solid #c8c8c8}.pager p{line-height:1.5em;margin:.5em 0}.pager p.next{float:right}.pager p.prev{float:left}details{margin-bottom:1em}details:hover{cursor:pointer}details summary{font-weight:bold}details summary h3,details summary h4,details summary h5,details summary h6{padding:0;display:inline}.lum-open .lum-img{margin:0 !important}button.simple{background-color:rgba(0,0,0,0);border:none;cursor:pointer;outline:none;padding:0;appearance:none}button.simple img{box-shadow:none;width:100%;height:auto}#disqus_thread{clear:both;position:relative}#disqus_thread span{position:absolute;font-weight:bold}.items-list :is(ul,ol) li{list-style:none;padding:.5rem 1rem}.items-list :is(ul,ol) li:nth-child(even){background:#f4f4f5}.items-list :is(ul,ol) time{padding:0 .25rem;color:#707070;white-space:nowrap}.strong{color:#003cb9 !important;font-weight:bold}table{caption-side:bottom}table caption{margin:.5em}pre.mermaid{border:none;background-color:inherit}.site-header{border-top:5px solid #303030;border-bottom:1px solid #d6d6d6;min-height:1.865em;position:relative}.site-title{font-size:26px;font-weight:300;line-height:72px;margin-bottom:0;float:left}.site-title,.site-title:visited{color:#303030}.site-nav{float:right;line-height:72px}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{display:none}.site-nav .page-link{color:#111;line-height:2}.site-nav .page-link:not(:last-child){margin-right:20px}@media screen and (max-width: 600px){.site-nav{position:absolute;top:9px;right:.5em;background-color:#fdfdfd;border:1px solid #d6d6d6;border-radius:5px;text-align:right}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav .menu-icon{display:block;float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg{fill:#303030}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}}.site-footer{border-top:1px solid #d6d6d6;padding:1em 0}.footer-heading{font-size:18px;margin-bottom:.5em}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#707070;margin-left:-0.5em}.footer-col{float:left;margin-bottom:.5em;padding-left:.5em}.footer-col-1{width:-webkit-calc(27% - (1em / 2));width:calc(27% - 1em/2)}.footer-col-2{width:-webkit-calc(26% - (1em / 2));width:calc(26% - 1em/2)}.footer-col-3{width:-webkit-calc(47% - (1em / 2));width:calc(47% - 1em/2)}@media screen and (max-width: 800px){.footer-col-1,.footer-col-2{width:-webkit-calc(50% - (1em / 2));width:calc(50% - 1em/2)}.footer-col-3{width:-webkit-calc(100% - (1em / 2));width:calc(100% - 1em/2)}}@media screen and (max-width: 600px){.footer-col{float:none;width:-webkit-calc(100% - (1em / 2));width:calc(100% - 1em/2)}}.page-content{padding:1em 0;flex:1}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:1em}.post-meta{font-size:14px;color:#707070}.post-link{display:block;font-size:24px}.post-header{margin-bottom:1em}.post-title{font-size:36px}@media screen and (max-width: 800px){.post-title{line-height:1}}.post-content{margin-bottom:1em}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:22px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}code{font-size:16px !important;font-family:Consolas,Menlo,Monaco,-apple-system,BlinkMacSystemFont,"Segoe UI",Meiryo,monospace !important}.highlight{clear:both}.highlight pre,.highlight code{line-height:1.5;background-color:#002346}figure.highlight,div.highlight,.highlight pre{border-radius:9px}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#c9d1d9;background-color:#161b22}.highlight .k,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kt,.highlight .kv{color:#ff7b72}.highlight .gr{color:#f0f6fc}.highlight .gd{color:#ffdcd7;background-color:#67060c}.highlight .nb{color:#ffa657}.highlight .nc{color:#ffa657}.highlight .no{color:#ffa657}.highlight .nn{color:#ffa657}.highlight .sr{color:#7ee787}.highlight .na{color:#7ee787}.highlight .nt{color:#7ee787}.highlight .gi{color:#aff5b4;background-color:#033a16}.highlight .kc{color:#79c0ff}.highlight .l,.highlight .ld,.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mx{color:#79c0ff}.highlight .sb{color:#79c0ff}.highlight .bp{color:#79c0ff}.highlight .ne{color:#79c0ff}.highlight .nl{color:#79c0ff}.highlight .py{color:#79c0ff}.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#79c0ff}.highlight .o,.highlight .ow{color:#79c0ff}.highlight .gh{color:#1f6feb;font-weight:bold}.highlight .gu{color:#1f6feb;font-weight:bold}.highlight .s,.highlight .sa,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .sx,.highlight .s1,.highlight .ss{color:#a5d6ff}.highlight .nd{color:#d2a8ff}.highlight .nf,.highlight .fm{color:#d2a8ff}.highlight .err{color:#f0f6fc;background-color:#8e1519}.highlight .c,.highlight .ch,.highlight .cd,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .c1,.highlight .cs{color:#acb4bd}.highlight .gl{color:#acb4bd}.highlight .gt{color:#acb4bd}.highlight .ni{color:#c9d1d9}.highlight .si{color:#c9d1d9}.highlight .ge{color:#c9d1d9;font-style:italic}.highlight .gs{color:#c9d1d9;font-weight:bold}/*# sourceMappingURL=/assets/main.css.map */</style>
  <link rel="icon" href="/assets/favicon.ico" />
  <link type="application/atom+xml" rel="alternate" href="https://embedded-kiddie.github.io/feed.xml" title="Embedded Kiddie" />
</head>
<body>
<header class="site-header" role="banner">
  <div class="wrapper">
<a class="site-title" rel="author" href="/">Embedded Kiddie</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>
        <div class="trigger">
<a class="page-link" href="/about/">About</a><a class="page-link" href="/privacy/">プライバシーポリシー</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - キャリブレーション編</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-06-22T19:06:03+09:00" itemprop="datePublished">Jun 22, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <style>
  .emphasis,
  #t1 tbody tr:nth-of-type(1),
  #t1 tbody tr:nth-of-type(2),
  #t1 tbody tr:nth-of-type(3),
  #t1 tbody tr:nth-of-type(9),
  #t1 tbody tr:nth-of-type(10),
  #t1 tbody tr:nth-of-type(11),
  #t2 tbody tr:nth-of-type(4) {
    background: #faf9cf;
    color: #041fcc !important;
    font-weight: bold;
  }
</style>

<p><img src="/images/2024/06-22/touch-sensor.jpg" alt="試作したタッチセンサ" title="試作したタッチセンサ" width="1380" height="1050"></p>

<p><a href="/2024/06/10/" title="Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 導入編 - Embedded Kiddie">導入編</a> で試作タッチパッドの動作確認を <a href="https://github.com/delta-G" title="delta-G (David)">Delta-G 氏</a> 製作の <a href="https://github.com/delta-G/R4_Touch" title="delta-G/R4_Touch: Capacitive Touch Sensing for the Arduino UNO-R4">R4_Touch</a> を使って行い、また <a href="/2024/06/16/" title="Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 基本編 | Embedded Kiddie">基本編</a> では <a href="#fig5" title="図５ CTSU 計測回路">CTSU 計測回路</a> の原理を紐解いてきましたが、日によってタッチ判定の閾値が微妙にズレて反応しなくなるという問題に遭遇しました。</p>

<p>おそらく気温や湿度、僕の指の静電容量変化が原因と思われますが、何らかの較正（＝計器類の狂い・精度を、標準器と比べて正すこと）の必要性を感じた次第です。</p>

<p>僕としてはこの較正を、静的または動的な <strong>キャリブレーション</strong> と呼びたいのですが、ルネサスでは <strong>チューニング</strong> と呼び（名前はどうでも良いですが…）、しっかり対策が準備されています。が、e² studio やら何やらが基本なので、Arduino 環境では工夫が必要です。</p>

<p>幸い僕らには <a href="https://github.com/delta-G/R4_Touch" title="delta-G/R4_Touch: Capacitive Touch Sensing for the Arduino UNO-R4">R4_Touch</a> という優れたライブラリがあるので、これを使って安定動作を目指すのが今回のテーマです。</p>

<h2 id="まずは結果から">まずは結果から</h2>

<p>以下の資料を参照し、試験的に作成したキャリブレーションの結果を示します。</p>

<ol>
  <li>
<span id="ref1"></span><a href="https://www.renesas.com/jp/ja/document/mah/renesas-ra4m1-group-users-manual-hardware?r=1054146" title="Renesas RA4M1グループ ユーザーズマニュアル ハードウェア編">Renesas RA4M1グループ ユーザーズマニュアル ハードウェア編</a>
</li>
  <li>
<span id="ref2"></span><a href="https://www.renesas.com/jp/ja/document/apn/capacitive-sensor-mcu-capacitive-touch-noise-immunity-guide?r=1054146" title="静電容量センサマイコン 静電容量タッチ ノイズイミュニティガイド">静電容量センサマイコン 静電容量タッチ ノイズイミュニティガイド</a>
</li>
  <li>
<span id="ref3"></span><a href="https://www.renesas.com/jp/ja/document/apn/capacitive-sensor-microcontrollers-ctsu-capacitive-touch-introduction-guide?r=1054146" title="静電容量センサマイコン 静電容量タッチ導入ガイド">静電容量センサマイコン 静電容量タッチ導入ガイド</a>
</li>
  <li>
<span id="ref4"></span><a href="https://www.renesas.com/jp/ja/document/apn/capacitive-sensor-mcu-qe-capacitive-touch-advanced-mode-parameter-guide?r=1054146" title="静電容量センサマイコン QE for Capacitive Touch アドバンスドモード(高度な設定)パラメータガイド">静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド</a>
</li>
  <li>
<span id="ref5"></span><a href="https://www.renesas.com/jp/ja/document/apn/ra-family-capacitive-touch-software-filter-sample-program?r=1054146" title="RAファミリ 静電容量タッチ ソフトウェアフィルタ サンプルプログラム">RAファミリ 静電容量タッチ ソフトウェアフィルタ サンプルプログラム</a>
</li>
</ol>

<p><a href="#fig1" title="図１ キャリブレーション前">図１</a> がキャリブレーション前の gif 動画で、R4_Touch デフォルトのパラメータを使用した動作例です（<a href="https://docs.arduino.cc/software/ide-v2/tutorials/ide-v2-serial-plotter/" title="Using the Serial Plotter Tool">シリアルプロッタ</a> は何気に便利ですね）。ピコピコと山が立っているところがタッチした瞬間です。見た通り、６個のスイッチの非タッチ状態（ベースライン）が異なります。</p>

<p>（<a href="https://github.com/delta-G" title="delta-G (David)">Delta-G 氏</a> の名誉のために言っておきますが、パラメータが悪い訳ではなく、<a href="https://forum.arduino.cc/t/lets-play-with-the-ctsu/1187758" title="Let's play with the CTSU! - UNO R4 Minima - Arduino Forum">よく実験をした上で</a>、大抵のケースに対応できるであろう値が設定されています。）</p>

<p>一方 <a href="#fig2" title="図２ キャリブレーション後">図２</a> のキャリブレーション後では、非タッチ状態のベースラインがほぼ揃い、閾値を１つにすることができました。暑い日でも雨でジトジトした日でも、安定して動作しています。</p>

<figure class="flex">
  <a href="/images/2024/06-22/calibration-before.gif" title="図１ キャリブレーション前" data-lightbox="image">
    <img id="fig1" src="/images/2024/06-22/calibration-before.jpg" alt="図１ キャリブレーション前" width="1594" height="926">
  <figcaption>図１ キャリブレーション前</figcaption>
  </a>
  <a href="/images/2024/06-22/calibration-after.gif" title="図２ キャリブレーション後" data-lightbox="image">
    <img id="fig2" src="/images/2024/06-22/calibration-after.jpg" alt="図２ キャリブレーション後" width="1594" height="926">
  <figcaption>図２ キャリブレーション後</figcaption>
  </a>
</figure>

<h2 id="タッチ判定処理の概要">タッチ判定処理の概要</h2>

<h3 id="処理フローの全体像">処理フローの全体像</h3>

<p><a href="#fig3" title="静電容量式タッチセンサの処理フローと CTSU ソフトウェア群">図３</a> に <a href="#ref5" title="RAファミリ 静電容量タッチ ソフトウェアフィルタ サンプルプログラム">資料５</a> から引用した全体像を示します。企業としては当たり前のことなのでしょうが、センサ形状やら使用環境やら、およそ商品開発に必要そうなツールやソフトウェアが準備されています。きっとこれらを研究・開発した人達がいるのでしょう、頭が下がります <img class="emoji" title=":100:" alt=":100:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4af.png" height="20" width="20"></p>

<figure>
  <img id="fig3" class="simple" src="/images/2024/06-22/software-group.jpg" alt="静電容量式タッチセンサの処理フローと CTSU ソフトウェア群" width="1380" height="440">
  <figcaption style="max-width:430px">図３ 静電容量式タッチセンサの処理フローと CTSU ソフトウェア群</figcaption>
</figure>

<p>また <a href="#ref4" title="静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド">資料４</a> には、<a href="#t1" title="表１ CTSU パラメータと調整手法の位置付け">表１</a> に示す通り、ルネサスが提供するツールを用いて調整できるパラメータが示されています（UNO R4 では設定できないパラメータは除外してあります）。</p>

<p>表中で<span class="emphasis"> ハイライトした行 </span>は、CTSU ドライバ（つまり R4_Touch）が扱うべきパラメータで、今回の較正対象です。残りはアプリケーションで扱うべきパラメータですね。</p>

<table id="t1">
  <thead>
    <tr>
      <th>CTSU パラメータ</th>
      <th style="text-align: center">自動チューニング</th>
      <th style="text-align: center">手動チューニング</th>
      <th style="text-align: center">高度なチューニング</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>計測（センサ駆動パルス）周波数</td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>ICO 電流オフセット量</td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>タッチ判定閾値</td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>ヒステリシス</td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>ドリフト補正間隔</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>長押しキャンセルのサイクル</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>ポジティブ・ノイズフィルタのサイクル</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>ネガティブ・ノイズフィルタのサイクル</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>移動平均フィルタの深度</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
      <td style="text-align: center"> </td>
    </tr>
    <tr>
      <td>計測回数</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
    </tr>
    <tr>
      <td>オフセットチューニング目標値</td>
      <td style="text-align: center"> </td>
      <td style="text-align: center"> </td>
      <td style="text-align: center">✔︎</td>
    </tr>
  </tbody>
  <caption>表１ CTSU パラメータと調整手法の位置付け</caption>
</table>

<h3 id="試験的キャリブレーション手法">試験的キャリブレーション手法</h3>

<p><a href="#ref3" title="静電容量センサマイコン 静電容量タッチ導入ガイド">資料３</a>、<a href="#ref4" title="静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド">資料４</a> を元に、今回実施した「セルフキャリブレーション」および「タッチ判定閾値のチューニング」に関する処理フローを <a href="#fig4" title="図４ キャリブレーション／チューニングと調整パラメータ">図４</a> に示します。</p>

<figure class="clear-both">
  <img id="fig4" class="simple" src="/images/2024/06-22/tuning-parameters.jpg" alt="図４ キャリブレーション／チューニングと調整パラメータ" width="1375" height="243">
  <figcaption style="max-width:370px">図４ キャリブレーション／チューニングと調整パラメータ</figcaption>
</figure>

<p>それぞれを順番に見ていくことにします。</p>

<h4 id="寄生容量の計測">寄生容量の計測</h4>

<p><a href="#fig3" title="静電容量式タッチセンサの処理フローと CTSU ソフトウェア群">図３</a> では、最初が「静電容量計測」となってますが、絶対値を測るわけではなく、非タッチ時の寄生容量とタッチ時の静電容量の差を計測します。で、その「容量」はというと、<a href="#fig5" title="図５ CTSU 計測回路">図５</a> に示す <a href="https://cc.cqpub.co.jp/system/contents/1349/" title="不要信号が減衰するスイッチト・キャパシタ・フィルタはどっち？ - CQ出版社 オンライン・サポート・サイト CQ connect">スイッチトキャパシタ</a> の原理を用いて、回路に流れる電流を計測します。</p>

<p>必然的に、スイッチトキャパシタに印加する「センサ駆動パルス」の周波数を適切に設定しなければなりません。何故なら、計測する静電容量が大きい場合、充放電のサイクルが短いと、放電し切らないうちに充電することになり、計測値に誤差が生じるからです。</p>

<p>ところが、その具体的手法や評価基準に関する記述が見当たりません。下記表を元にルネサス製のツールが「最適値を設定する」か「高度なチューニングで設定する」との記述があるだけです。きっとルネサスのノウハウなのでしょう。</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th style="text-align: center">計測（センサ駆動パルス）周波数</th>
      <th style="text-align: center">計測回数</th>
      <th style="text-align: center">計測時間 [μs]</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CTSU（RX130 の例）</td>
      <td style="text-align: center">4.0 MHz</td>
      <td style="text-align: center">8</td>
      <td style="text-align: center">526</td>
    </tr>
    <tr>
      <td>^</td>
      <td style="text-align: center">2.0 MHz</td>
      <td style="text-align: center">4</td>
      <td style="text-align: center">^</td>
    </tr>
    <tr>
      <td>^</td>
      <td style="text-align: center">1.0 MHz</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">^</td>
    </tr>
    <tr>
      <td>^</td>
      <td style="text-align: center">0.5 MHz</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">^</td>
    </tr>
  </tbody>
</table>

<p>ではどうしたかと言うと、「<strong>オフセットチューニング目標値</strong>」に対する「<strong>ターゲット値</strong>」なるものが示されているので、計測値が、デフォルトとされる「<span class="emphasis">37.5%</span>」に対する「<span class="emphasis">15360</span>」に最も近くなる「<strong>計測（センサ駆動パルス）周波数</strong>」と「<strong>計測回数</strong>」の組み合わせを探索することにしました。</p>

<table id="t2">
  <thead>
    <tr>
      <th style="text-align: center">オフセットチューニング目標値</th>
      <th style="text-align: center">ターゲット値</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">25.0%</td>
      <td style="text-align: center">10240</td>
    </tr>
    <tr>
      <td style="text-align: center">30.0%</td>
      <td style="text-align: center">12288</td>
    </tr>
    <tr>
      <td style="text-align: center">35.0%</td>
      <td style="text-align: center">14336</td>
    </tr>
    <tr>
      <td style="text-align: center">37.5%</td>
      <td style="text-align: center">15360</td>
    </tr>
    <tr>
      <td style="text-align: center">40.0%</td>
      <td style="text-align: center">16384</td>
    </tr>
    <tr>
      <td style="text-align: center">45.0%</td>
      <td style="text-align: center">18432</td>
    </tr>
    <tr>
      <td style="text-align: center">50.0%</td>
      <td style="text-align: center">20480</td>
    </tr>
  </tbody>
</table>

<p>ここではプログラムを見るより、探索処理が出力するデバッグ情報の方がイメージが湧き易いと思うので、以下に説明を試みます。まずは記号の説明です。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">記号</th>
      <th>説明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">SNUM</code></td>
      <td>CSTS パラメータのうち、<strong>計測回数</strong> を表します。</td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">SPDA</code></td>
      <td>
<strong>計測（センサ駆動パルス）周波数</strong> をベースクロックの分周比で表したものです。ベースクロックを周辺回路クロック <code class="language-plaintext highlighter-rouge">PCLKB</code>（24MHz）に設定した場合、例えば分周比「<code class="language-plaintext highlighter-rouge">2</code>」は <code class="language-plaintext highlighter-rouge">1/6</code>、即ち 4MHz を表します。以降分周比が「<code class="language-plaintext highlighter-rouge">1</code>」増える毎に <code class="language-plaintext highlighter-rouge">1/8</code>、<code class="language-plaintext highlighter-rouge">1/10</code>、… と続きます。</td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">RC</code></td>
      <td>リファレンスカウンタを意味しますが、探索処理では計測レンジの上限値を表しています。</td>
    </tr>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">SC</code></td>
      <td>センサカウンタ、即ち計測された静電容量に相当します。</td>
    </tr>
  </tbody>
</table>

<p>また <a href="#ref4" title="静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド">資料４</a> から次の制約条件を読み取りました。</p>

<ul>
  <li>センサカウンタ <code class="language-plaintext highlighter-rouge">SC</code> と計測範囲の上限値 <code class="language-plaintext highlighter-rouge">RC</code> はオーバーフローしてはならない</li>
  <li>センサカウンタ <code class="language-plaintext highlighter-rouge">SC</code> は計測範囲の上限値 <code class="language-plaintext highlighter-rouge">RC</code> を超えてはならない</li>
  <li>計測範囲の上限値 <code class="language-plaintext highlighter-rouge">RC</code> は、100% のターゲット値（40960）より広くなければならない</li>
</ul>

<p>この制約条件の元に、センサカウンタ <code class="language-plaintext highlighter-rouge">SC</code> が <strong>ターゲット値の 15360</strong> に最も近くなる <code class="language-plaintext highlighter-rouge">SNUM</code> と <code class="language-plaintext highlighter-rouge">SPDA</code> の組み合わせを探索することとしています。</p>

<p>以下は、あるタッチ電極に対する探索結果です。３つの候補（<code class="language-plaintext highlighter-rouge">target candidate</code>）のうち、最後の <strong>計測回数＝1</strong> と <strong>計測（センサ駆動パルス）周波数＝16</strong> が解として求まりました。</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="n">SNUM</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">2</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">58979</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">65535</span> <span class="o">--&gt;</span> <span class="n">overflow</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">2</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">29488</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">46677</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">3</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">39322</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">52285</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">4</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">49156</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">55369</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">5</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">58989</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">57460</span> <span class="o">--&gt;</span> <span class="n">target</span> <span class="n">candidate</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">6</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">65535</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">59027</span> <span class="o">--&gt;</span> <span class="n">overflow</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">2</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">14743</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">23334</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">3</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">19663</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">26164</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">4</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">24579</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">27676</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">5</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">29494</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">28711</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">6</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">34416</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">29514</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">7</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">39316</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">30128</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">8</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">44254</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">30679</span> <span class="o">--&gt;</span> <span class="n">target</span> <span class="n">candidate</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">9</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">49160</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">31144</span> <span class="o">--&gt;</span> <span class="n">target</span> <span class="n">overshoot</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">2</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span>  <span class="m">7365</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">11657</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">3</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span>  <span class="m">9824</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">13090</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">4</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">12292</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">13862</span> <span class="o">--&gt;</span> <span class="n">SC</span><span class="o">:</span> <span class="n">out</span> <span class="n">of</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">5</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">14752</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">14359</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">6</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">17211</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">14750</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">7</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">19669</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">15079</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">8</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">22128</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">15348</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span>  <span class="m">9</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">24582</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">15584</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">27035</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">15741</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">11</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">29497</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">15918</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">12</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">31963</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16085</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">13</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">34415</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16240</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">36879</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16327</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">15</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">39341</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16483</span> <span class="o">--&gt;</span> <span class="n">RC</span><span class="o">:</span> <span class="n">narrow</span> <span class="k">range</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">16</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">41796</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16566</span> <span class="o">--&gt;</span> <span class="n">target</span> <span class="n">candidate</span>
<span class="n">SNUM</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">SDPA</span> <span class="o">=</span> <span class="m">17</span><span class="p">,</span> <span class="n">RC</span> <span class="o">=</span> <span class="m">44231</span><span class="p">,</span> <span class="n">SC</span> <span class="o">=</span> <span class="m">16689</span> <span class="o">--&gt;</span> <span class="n">target</span> <span class="n">overshoot</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">Measurements</span> <span class="p">(</span><span class="n">CTSUSO0</span><span class="o">.</span><span class="n">CTSUSNUM</span><span class="p">)</span><span class="o">:</span> <span class="m">1</span>
<span class="n">Sensor</span> <span class="n">Drive</span> <span class="n">Pulse</span> <span class="p">(</span><span class="n">CTSUSO1</span><span class="o">.</span><span class="n">CTSUSDPA</span><span class="p">)</span><span class="o">:</span> <span class="m">16</span></code></pre></figure>

<p>う〜ん、これでも分かり難いですネ。</p>

<h4 id="オフセットチューニング">オフセットチューニング</h4>

<p>そもそも「オフセット」とは何なのか、<a href="https://www.renesas.com/jp/ja/document/mah/renesas-ra4m1-group-users-manual-hardware?r=1054146" title="RA4M1 - 48MHz Arm® Cortex®-M4 と LCDコントローラおよびHMI用静電容量式タッチセンサ搭載 32 ビットマイクロコントローラ - Renesas">ハードウェアマニュアル</a> や <a href="#ref4" title="静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド">資料４</a> を読んでいて、最も分かり難かったのがこのパートです。<a href="#fig5" title="図５ CTSU 計測回路">図５</a>、<a href="#fig6" title="図６ 自己容量方式のオフセットチューニング処理">図６</a> の僕の解釈は、次のようになります。</p>

<div class="quote clear-both">

<p>電源からの <span style="color:red"><code class="language-plaintext highlighter-rouge">I1</code></span> に比例した電流が、電流ミラー回路を通じて <span style="color:red"><code class="language-plaintext highlighter-rouge">Iout</code></span> として出力され、ICO（電流制御発振器）で変換されたパルスがセンサカウンタ <code class="language-plaintext highlighter-rouge">SC</code> として計測される。</p>

<p>一方、実際の静電容量は、スイッチトキャパシタにセンサ駆動パルスを印加する DAC からの電流 <span style="color:red"><code class="language-plaintext highlighter-rouge">I2</code></span> も流れ込んで計測されるため、この影響を排除する必要がある。</p>

</div>

<p>つまり「ICO の制御電流 <span style="color:red"><code class="language-plaintext highlighter-rouge">Iout</code></span> で補正してやろう」という魂胆だと解釈したワケです。この手の補正をハードで処理するかソフトでやるかは、ありがちな選択肢だと思います。</p>

<figure class="flex">
  <a href="/images/2024/06-22/CTSU-circuit.jpg" title="図５ CTSU 計測回路" data-lightbox="image">
    <img id="fig5" class="simple" src="/images/2024/06-22/CTSU-circuit.jpg" alt="図５ CTSU 計測回路" width="1080" height="580">
    <figcaption>図５ CTSU 計測回路</figcaption>
  </a>
  <a href="/images/2024/06-22/offset-tuning.jpg" title="図６ 自己容量方式のオフセットチューニング処理" data-lightbox="image">
    <img id="fig6" class="simple" src="/images/2024/06-22/offset-tuning.jpg" alt="図６ 自己容量方式のオフセットチューニング処理" width="1080" height="580">
    <figcaption style="max-width:320px">図６ 自己容量方式のオフセットチューニング処理</figcaption>
  </a>
</figure>

<p>と言うことで、本パートのデバッグ出力を示します。<strong>ターゲット値の 15360</strong> とセンサカウンタ <code class="language-plaintext highlighter-rouge">SC</code> との差 <code class="language-plaintext highlighter-rouge">diff</code> が最小となる <code class="language-plaintext highlighter-rouge">offset</code> を <strong>ICO 電流オフセット量</strong> として決定しています。</p>

<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">offset</span>: <span class="m">0</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">16687</span>, <span class="n">diff</span>: <span class="m">1327</span>
<span class="n">offset</span>: <span class="m">1</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">16492</span>, <span class="n">diff</span>: <span class="m">1132</span>
<span class="n">offset</span>: <span class="m">2</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">16305</span>, <span class="n">diff</span>: <span class="m">945</span>
<span class="n">offset</span>: <span class="m">3</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">16119</span>, <span class="n">diff</span>: <span class="m">759</span>
<span class="n">offset</span>: <span class="m">4</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">15960</span>, <span class="n">diff</span>: <span class="m">600</span>
<span class="n">offset</span>: <span class="m">5</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">15765</span>, <span class="n">diff</span>: <span class="m">405</span>
<span class="n">offset</span>: <span class="m">6</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">15596</span>, <span class="n">diff</span>: <span class="m">236</span>
<span class="n">offset</span>: <span class="m">7</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">15420</span>, <span class="n">diff</span>: <span class="m">60</span>
<span class="n">offset</span>: <span class="m">8</span>, <span class="n">sensor</span> <span class="n">count</span>: <span class="m">15237</span>, <span class="n">diff</span>: <span class="m">123</span>
<span class="n">Sensor</span> <span class="n">offset</span> (<span class="n">CTSUSO0</span>.<span class="n">CTSUSO</span>): <span class="m">7</span></code></pre></figure>

<p>また <a href="#ref4" title="静電容量センサマイコン アドバンスドモード(高度な設定)パラメータガイド">資料４</a> には、この想定が成り立つ条件として以下の記述があり、念のため確認しました。</p>

<blockquote>
  <p>計測値は、電流制御発振器（ICO）の出力リニアリティ特性の良い範囲に収まるようにオフセットチューニング目標値を調整する必要があります。</p>
</blockquote>

<figure class="float-left" id="fig7">
  <a href="/images/2024/06-22/ico-characteristic.png" title="ICO リファレンスカウンタ特性" data-lightbox="image">
    <img class="simple" src="/images/2024/06-22/ico-characteristic-small.jpg" alt="ICO リファレンスカウンタ特性" width="459" height="327">
  <figcaption>図７ ICO リファレンスカウンタ特性</figcaption>
  </a>
</figure>

<p><a href="#fig7" title="図７ ICO リファレンスカウンタ特性">図７</a> は、ICO リファレンスカウンタの特性を測定したグラフです。もう一方のセンサカウンタも、回路的にはほぼ同じ特性を持つと考えて良いかと思います。</p>

<p>ただ、このグラフをもって「出力リニアリティ特性の良い範囲に収まる」と判断して良いかは、定かではありません…</p>

<div class="clear-both"></div>

<p>さて、試作したタッチパッドの６個のタッチ電極に、上記処理を施した結果を示します。各電極で <code class="language-plaintext highlighter-rouge">offset</code> が働き、冒頭の <a href="#fig2" title="図２ キャリブレーション後">図２</a> で示した通り、非タッチ状態での計測結果（ベースライン）が、ほぼ <strong>ターゲット値の 15360</strong> 付近に揃う結果となりました。メデタシ、メデタシ。</p>

<figure class="highlight"><pre><code class="language-conf" data-lang="conf"><span class="n">pin</span>:  <span class="m">9</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>: <span class="m">13</span>, <span class="n">count</span>: <span class="m">1</span>
<span class="n">pin</span>:  <span class="m">8</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>: <span class="m">14</span>, <span class="n">count</span>: <span class="m">1</span>
<span class="n">pin</span>: <span class="m">15</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>: <span class="m">33</span>, <span class="n">count</span>: <span class="m">1</span>
<span class="n">pin</span>: <span class="m">16</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>: <span class="m">35</span>, <span class="n">count</span>: <span class="m">1</span>
<span class="n">pin</span>:  <span class="m">3</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>:  <span class="m">7</span>, <span class="n">count</span>: <span class="m">1</span>
<span class="n">pin</span>:  <span class="m">2</span>, <span class="n">div</span>: <span class="m">16</span>, <span class="n">gain</span>: <span class="m">0</span>, <span class="n">ref_current</span>: <span class="m">0</span>, <span class="n">offset</span>:  <span class="m">0</span>, <span class="n">count</span>: <span class="m">1</span></code></pre></figure>

<h4 id="感度計測--タッチ判定閾値決定">感度計測 〜 タッチ判定閾値決定</h4>

<p>今回は、ほぼ全てのタッチ電極特性が揃ったのをイイことに、<strong>ターゲット値の 15360</strong> に適当なゲタを履かせて閾値としました。しかし本来は、非タッチ時とタッチ時の計測結果を統計処理するなどして、それぞれのタッチ電極ごとに閾値を決めるべきです。</p>

<p>また実用上は、タッチパッドに汚れが付着したり、一時的に水滴が付くなど、ベースラインが変化する可能性もあるので、ドリフト補正も必要です。</p>

<p>今のところタッチ判定に影響を与えるほどではありませんが、油性マジックで描いた囲み数字がかすれてくる程度にペタペタと触っているためか（手垢が付着!?）、現にドリフトが発生し始めています。</p>

<p>タッチ電極ごとに閾値を持たせれば、移動平均や適当な時定数でフィルタ処理するなど、ドリフト補正の実装も容易だと思います。</p>

<h3 id="サンプルプログラム">サンプルプログラム</h3>

<p>今回作成のソースコードを <a href="https://github.com/embedded-kiddie/Arduino-UNO-R4/tree/main/capacitive_touch" title="Arduino-UNO-R4/capacitive_touch at main · embedded-kiddie/Arduino-UNO-R4">GitHub に上げました</a>。「<a href="/2024/06/03/" title="Arduino UNO R4の周辺回路レジスタをモニターするプログラム - Embedded Kiddie">Arduino UNO R4の周辺回路レジスタをモニターするプログラム</a>」で作成した <a href="https://github.com/embedded-kiddie/PeripheralMonitor" title="embedded-kiddie/PeripheralMonitor: Arduino UNO R4 Minima/WiFi peripheral register monitor though the external serial I/F (Serial1) at D0(RX)/D1(TX)">PeripheralMonitor</a> が組み込んであったりと、少々分かり難いところがあるかも知れませんが、紹介しなかった CTSU ドライバでの「移動平均」も組み込んであるので、よかったら覗いてみてください。</p>

<h2 id="おことわり">おことわり</h2>

<p><a href="https://github.com/delta-G/R4_Touch" title="delta-G/R4_Touch: Capacitive Touch Sensing for the Arduino UNO-R4">R4_Touch</a> には <a href="https://github.com/delta-G/R4_Touch/tree/master/examples/Auto_Tune" title="R4_Touch/examples/Auto_Tune at master · delta-G/R4_Touch">自動チューニングのサンプル</a> が添付されていますが、UNO R4 FiWi からのコマンド入力がうまくいかなかったり、算出されたパラメータやタッチ判定の閾値がイマイチだったりと、現時点のバージョンは、僕が試作したパッドと相性が良くありません。原因は CTSU 仕様の解釈の違いにあります。</p>

<p>とは言え、今回紹介した僕の手法が、他の人にとって合わない可能性もあります。<a href="https://forum.arduino.cc/t/lets-play-with-the-ctsu/1187758/20" title="Let's play with the CTSU! - Delta_G の #19 - UNO R4 Minima - Arduino Forum">Delta-G 氏の言葉</a> を借りれば、これで「間違いない」とか、「最善である」とか、「正解である」などと主張するつもりは毛頭ありません。</p>

<p>質問や疑問、ご提案などあれば、コメントを頂ければと思いますし、<a href="https://forum.arduino.cc/t/lets-play-with-the-ctsu/1187758" title="Let's play with the CTSU! - UNO R4 Minima - Arduino Forum">フォーラムでの議論</a> にご参加頂ければ、なお良いと思います <img class="emoji" title=":dizzy:" alt=":dizzy:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ab.png" height="20" width="20"></p>

<h3 id="最後にちょっとだけ注意事項を">最後にちょっとだけ注意事項を…</h3>

<p><a href="#ref2" title="静電容量センサマイコン 静電容量タッチ ノイズイミュニティガイド">資料２</a> には、TS 端子とタッチ電極の間にダンピング抵抗を接続することが推奨されています。一方 <a href="https://docs.arduino.cc/resources/schematics/ABX00080-schematics.pdf" title="ABX00080-schematics.pdf">Minima の回路図</a> や <a href="https://docs.arduino.cc/resources/schematics/ABX00087-schematics.pdf" title="ABX00087-schematics.pdf">WiFi の回路図</a> を見ると、Love ピンは直接 MCU に接続されていています。無闇に触って静電気で MCU にダメージを与えないよう、注意しましょう！</p>


  </div>
  <div class="wrapper pager">
    <p class="prev">
      <a href="/2024/06/16/" title="前の記事：Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 基本編">← Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 基本編</a>
    </p>

    <p class="next">
      <a href="/2024/06/28/" title="次の記事：Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 感圧センシング編">Arduino UNO R4 静電容量式タッチセンシングユニット(CTSU) - 感圧センシング編 →</a>
    </p>    
  </div>
<div id="disqus_thread">
<span id="disqus-comment-count" class="disqus-comment-count" data-disqus-url="https://embedded-kiddie.github.io/2024/06/22/"></span><button id="open_disqus" class="simple" title="クリックするとコメントフォームが開きます"><img src="/images/comment-disqus.png" width="1536" height="866" alt="Disqus コメントフォーム"></button>
</div>
<a class="u-url" href="/2024/06/22/" hidden></a>
</article>

      </div>
    </main>
<footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Embedded Kiddie</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kingsman</li>
<li><a class="u-email" href="https://mailhide.io/e/DpUPhw9C" onclick="popup=window.open('https://mailhide.io/e/DpUPhw9C','mailhidepopup','width=580,height=635'); return false;">e......@gmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
<li><a href="https://github.com/embedded-kiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">embedded-kiddie</span></a></li>
<li><a href="https://www.twitter.com/EmbeddedKiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">EmbeddedKiddie</span></a></li>
<li><a href="https://youtube.com/@EmbeddedKiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">EmbeddedKiddie</span></a></li>
</ul></div>

      <div class="footer-col footer-col-3">
        <p>組み込みエンジニア。かつては趣味でWordPressプラグインなどリリース。 興味をロボットや電子工作に転じ、ハードとソフトを再勉強する日々。</p>
      </div>
    </div>

  </div>
  <button id="js-pagetop" class="pagetop"><span class="pagetop_arrow"></span></button>
</footer>

<script>'use strict';(function(){const b=document.querySelector("#js-pagetop");b.addEventListener("click",c=>{function e(a){null==d&&(d=a);a-=d;var f=a/500;window.scrollTo(0,g-g*(1===f?1:-Math.pow(2,-10*f)+1));500>a?requestAnimationFrame(e):window.scroll(h)}c.stopPropagation();const h={top:0,left:0},g=window.scrollY;let d=null;window.scroll(h);requestAnimationFrame(e)});window.addEventListener("scroll",c=>{1<window.scrollY?b.classList.add("fadeIn"):b.classList.remove("fadeIn");"undefined"===typeof commentCount||commentCount.done||commentCount.show(c)});const T=document.querySelector('#disqus-comment-count');const commentCount={done:!1,show:function(e){const r=T.getBoundingClientRect();if(r.top<=window.innerHeight&&r.bottom>=0){this.done=!0;const s=document.createElement('script');s.id="dsq-count-scr";s.src="https://embedded-kiddie.disqus.com/count.js";T.appendChild(s)}}};if("embedded-kiddie.github.io"===window.location.hostname){const o=new MutationObserver(records=>{let t=T.textContent.substring(0,1);if(t+0!==0){let e=new Event('click');document.querySelector('#open_disqus').dispatchEvent(e)}});o.observe(T,{childList:!0});document.querySelector('#open_disqus').addEventListener('click',(e)=>{var disqus_config=function(){this.page.url="https://embedded-kiddie.github.io/2024/06/22/";this.page.identifier="/2024/06/22/"};const d=document,s=d.createElement('script');s.src="https://embedded-kiddie.disqus.com/embed.js";s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);o.disconnect()})}})();</script>
<script async src="https://cdn.jsdelivr.net/npm/luminous-lightbox@2.4.0/dist/luminous.min.js" integrity="sha256-4vMnmzhFzuXVxRHRFNwJzPnT923+MfWHWU4deBjd/vQ=" crossorigin="anonymous"></script>
<script async src="/assets/luminous-config.min.js"></script>
</body>
</html>