<!DOCTYPE html>
<html lang="en"><head>
  <script>'use strict';if("embedded-kiddie.github.io"===window.location.hostname){var s=document.createElement("script");s.src="https://www.googletagmanager.com/gtag/js?id=G-DLMCZ884M2";document.head.appendChild(s);window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-DLMCZ884M2")};</script>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Arduino UNO R4用バックグラウンドミュージック再生ライブラリの紹介 | Embedded Kiddie</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Arduino UNO R4用バックグラウンドミュージック再生ライブラリの紹介" />
<meta name="author" content="Kingsman" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="BGM 再生といっても tone() のことです、悪しからず。" />
<meta property="og:description" content="BGM 再生といっても tone() のことです、悪しからず。" />
<link rel="canonical" href="https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html" />
<meta property="og:url" content="https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html" />
<meta property="og:site_name" content="Embedded Kiddie" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-12T13:02:37+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Arduino UNO R4用バックグラウンドミュージック再生ライブラリの紹介" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kingsman"},"dateModified":"2024-05-18T20:44:14+09:00","datePublished":"2024-04-12T13:02:37+09:00","description":"BGM 再生といっても tone() のことです、悪しからず。","headline":"Arduino UNO R4用バックグラウンドミュージック再生ライブラリの紹介","mainEntityOfPage":{"@type":"WebPage","@id":"https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html"},"url":"https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html"}</script>
<!-- End Jekyll SEO tag -->

  <style type="text/css">body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0}body{font:400 16px/2 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";color:#111;background-color:#fdfdfd;-webkit-text-size-adjust:100%;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1;font-feature-settings:"kern" 1;font-kerning:normal;display:flex;min-height:100vh;flex-direction:column}p,blockquote,pre,ul,ol,dl,figure{margin-bottom:1em}h1,h2,h3,h4,h5,h6{padding-top:1em;margin-bottom:1em;clear:both}main{display:block}img{max-width:100%;vertical-align:middle;height:auto}figure>img{display:block}figcaption{font-size:14px;max-width:230px;width:fit-content;margin-right:auto;margin-left:auto;text-align:center}ul,ol{margin-left:1em}li>ul,li>ol{margin-bottom:0}h1,h2,h3,h4,h5,h6{font-weight:400}.e-content h1,.e-content h2,.e-content h3,.e-content h4,.e-content h5,.e-content h6{font-weight:600}h2+h3,h3+h4,h4+h5{padding-top:0}a{color:#2a7ae2;text-decoration:none}a:visited{color:#1756a9}a:hover{color:#111;text-decoration:underline}.social-media-list a:hover{text-decoration:none}.social-media-list a:hover .username{text-decoration:underline}blockquote{color:#707070;border-left:4px solid #d6d6d6;padding-left:.5em;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre,code{font-size:15px;border:1px solid #d6d6d6;border-radius:3px;background-color:#eef}code{padding:1px 5px}pre{padding:8px 12px;overflow-x:auto}pre>code{border:0;padding-right:0;padding-left:0}.wrapper{max-width:-webkit-calc(800px - (1em * 2));max-width:calc(800px - 1em*2);margin-right:auto;margin-left:auto;padding-right:1em;padding-left:1em}@media screen and (max-width: 800px){.wrapper{max-width:-webkit-calc(800px - (1em));max-width:calc(800px - (1em));padding-right:.5em;padding-left:.5em}}.footer-col-wrapper:after,.wrapper:after{content:"";display:table;clear:both}.svg-icon{width:16px;height:16px;display:inline-block;fill:#707070;padding-right:5px;vertical-align:text-top}.social-media-list li+li{padding-top:5px}table{margin-bottom:1em;width:100%;text-align:left;font-size:85%;color:#1e1e1e;border-collapse:collapse;border:1px solid #d6d6d6}table tr:nth-child(even){background-color:#f7f7f7}table th,table td{padding:.3333333333em .5em}table th{background-color:#e5e5e5;border:1px solid #c2c2c2;border-bottom-color:#b7b7b7}table td{border:1px solid #d6d6d6}h5{font-size:1em}.post-content{font-size:1.125rem}.center{text-align:center}.float-left{float:left;margin:0 .75em 0 0;padding:0 .75em 0 0;width:30%}.clear-both{clear:both}video{max-width:100%;padding:0 0 1em 0;margin:auto}a[href^=http]:not(.simple):after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQElEQVR42qXKwQkAIAxDUUdxtO6/RBQkQZvSi8I/pL4BoGw/XPkh4XigPmsUgh0626AjRsgxHTkUThsG2T/sIlzdTsp52kSS1wAAAABJRU5ErkJggg==);margin:0 3px 0 5px}figure.flex{display:flex;text-align:center;justify-content:space-around}figure.flex a{margin:0 .25em}img{margin:.5em 0 1em 0;box-shadow:0 5px 10px 0 rgba(0,0,0,.1)}img.emoji{height:1.5em;width:1.5em;margin:0 0 .25em 0;box-shadow:none}span.emoji{font-size:1.5em;line-height:1em}span.inline img{height:1.5em;margin:0;box-shadow:none}td img{margin-bottom:0}img.simple{box-shadow:none;width:100%}.twitter-tweet{padding-bottom:.5em}.quote,.notice{padding:.5em 1em;margin:1em 0 2em 0;color:#505050;background:#fff;border-radius:10px}.quote h3,.quote h4,.quote h5,.quote p:last-child,.notice h3,.notice h4,.notice h5,.notice p:last-child{margin:0;padding:0}.quote{border:solid 3px #5c81e6}.notice{border:solid 3px #e01b7e}figcaption{margin-bottom:1em}footer.site-footer div{font-size:16px !important}header h1,footer div{line-height:1.5}.pagetop{height:50px;width:50px;position:fixed;right:30px;bottom:50px;background:#fff;border:solid 2px #000;border-radius:50%;display:flex;justify-content:center;align-items:center;z-index:2;cursor:pointer;transition:all .3s;opacity:0;visibility:hidden}.pagetop_arrow{display:block;height:10px;width:10px;border-top:3px solid #000;border-right:3px solid #000;transform:translateY(20%) rotate(-45deg)}.pagetop.fadeIn{opacity:.5;visibility:inherit}.pagetop:hover{opacity:1}.pager{clear:both;margin:2em 0;border-top:1px solid #c8c8c8;border-bottom:1px solid #c8c8c8}.pager p{line-height:1.5em;margin:.5em 0}.pager p.next{float:right}.pager p.prev{float:left}details{margin-bottom:1em}details:hover{cursor:pointer}details summary{font-weight:bold}details summary h3,details summary h4,details summary h5,details summary h6{padding:0;display:inline}.lum-open .lum-img{margin:0 !important}button.simple{background-color:rgba(0,0,0,0);border:none;cursor:pointer;outline:none;padding:0;appearance:none}button.simple img{box-shadow:none;width:100%;height:auto}#disqus_thread{clear:both;position:relative}#disqus_thread span{position:absolute;font-weight:bold}.items-list :is(ul,ol) li{list-style:none;padding:.5rem 1rem}.items-list :is(ul,ol) li:nth-child(even){background:#f4f4f5}.items-list :is(ul,ol) time{padding:0 .25rem;color:#707070;white-space:nowrap}.strong{color:#003cb9 !important;font-weight:bold}table{caption-side:bottom}table caption{margin:.5em}pre.mermaid{border:none;background-color:inherit}.site-header{border-top:5px solid #303030;border-bottom:1px solid #d6d6d6;min-height:1.865em;position:relative}.site-title{font-size:26px;font-weight:300;line-height:72px;margin-bottom:0;float:left}.site-title,.site-title:visited{color:#303030}.site-nav{float:right;line-height:72px}.site-nav .nav-trigger{display:none}.site-nav .menu-icon{display:none}.site-nav .page-link{color:#111;line-height:2}.site-nav .page-link:not(:last-child){margin-right:20px}@media screen and (max-width: 600px){.site-nav{position:absolute;top:9px;right:.5em;background-color:#fdfdfd;border:1px solid #d6d6d6;border-radius:5px;text-align:right}.site-nav label[for=nav-trigger]{display:block;float:right;width:36px;height:36px;z-index:2;cursor:pointer}.site-nav .menu-icon{display:block;float:right;width:36px;height:26px;line-height:0;padding-top:10px;text-align:center}.site-nav .menu-icon>svg{fill:#303030}.site-nav input~.trigger{clear:both;display:none}.site-nav input:checked~.trigger{display:block;padding-bottom:5px}.site-nav .page-link{display:block;padding:5px 10px;margin-left:20px}.site-nav .page-link:not(:last-child){margin-right:0}}.site-footer{border-top:1px solid #d6d6d6;padding:1em 0}.footer-heading{font-size:18px;margin-bottom:.5em}.contact-list,.social-media-list{list-style:none;margin-left:0}.footer-col-wrapper{font-size:15px;color:#707070;margin-left:-0.5em}.footer-col{float:left;margin-bottom:.5em;padding-left:.5em}.footer-col-1{width:-webkit-calc(27% - (1em / 2));width:calc(27% - 1em/2)}.footer-col-2{width:-webkit-calc(26% - (1em / 2));width:calc(26% - 1em/2)}.footer-col-3{width:-webkit-calc(47% - (1em / 2));width:calc(47% - 1em/2)}@media screen and (max-width: 800px){.footer-col-1,.footer-col-2{width:-webkit-calc(50% - (1em / 2));width:calc(50% - 1em/2)}.footer-col-3{width:-webkit-calc(100% - (1em / 2));width:calc(100% - 1em/2)}}@media screen and (max-width: 600px){.footer-col{float:none;width:-webkit-calc(100% - (1em / 2));width:calc(100% - 1em/2)}}.page-content{padding:1em 0;flex:1}.page-heading{font-size:32px}.post-list-heading{font-size:28px}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:1em}.post-meta{font-size:14px;color:#707070}.post-link{display:block;font-size:24px}.post-header{margin-bottom:1em}.post-title{font-size:36px}@media screen and (max-width: 800px){.post-title{line-height:1}}.post-content{margin-bottom:1em}.post-content h2{font-size:32px}@media screen and (max-width: 800px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 800px){.post-content h3{font-size:22px}}.post-content h4{font-size:22px}@media screen and (max-width: 800px){.post-content h4{font-size:18px}}code{font-size:16px !important;font-family:Consolas,Menlo,Monaco,-apple-system,BlinkMacSystemFont,"Segoe UI",Meiryo,monospace !important}.highlight{clear:both}.highlight pre,.highlight code{line-height:1.5;background-color:#002346}figure.highlight,div.highlight,.highlight pre{border-radius:9px}.highlight table td{padding:5px}.highlight table pre{margin:0}.highlight,.highlight .w{color:#c9d1d9;background-color:#161b22}.highlight .k,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .kt,.highlight .kv{color:#ff7b72}.highlight .gr{color:#f0f6fc}.highlight .gd{color:#ffdcd7;background-color:#67060c}.highlight .nb{color:#ffa657}.highlight .nc{color:#ffa657}.highlight .no{color:#ffa657}.highlight .nn{color:#ffa657}.highlight .sr{color:#7ee787}.highlight .na{color:#7ee787}.highlight .nt{color:#7ee787}.highlight .gi{color:#aff5b4;background-color:#033a16}.highlight .kc{color:#79c0ff}.highlight .l,.highlight .ld,.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .il,.highlight .mo,.highlight .mx{color:#79c0ff}.highlight .sb{color:#79c0ff}.highlight .bp{color:#79c0ff}.highlight .ne{color:#79c0ff}.highlight .nl{color:#79c0ff}.highlight .py{color:#79c0ff}.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#79c0ff}.highlight .o,.highlight .ow{color:#79c0ff}.highlight .gh{color:#1f6feb;font-weight:bold}.highlight .gu{color:#1f6feb;font-weight:bold}.highlight .s,.highlight .sa,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .sx,.highlight .s1,.highlight .ss{color:#a5d6ff}.highlight .nd{color:#d2a8ff}.highlight .nf,.highlight .fm{color:#d2a8ff}.highlight .err{color:#f0f6fc;background-color:#8e1519}.highlight .c,.highlight .ch,.highlight .cd,.highlight .cm,.highlight .cp,.highlight .cpf,.highlight .c1,.highlight .cs{color:#acb4bd}.highlight .gl{color:#acb4bd}.highlight .gt{color:#acb4bd}.highlight .ni{color:#c9d1d9}.highlight .si{color:#c9d1d9}.highlight .ge{color:#c9d1d9;font-style:italic}.highlight .gs{color:#c9d1d9;font-weight:bold}/*# sourceMappingURL=/assets/main.css.map */</style>
  <link rel="icon" href="/assets/favicon.ico" />
  <link type="application/atom+xml" rel="alternate" href="https://embedded-kiddie.github.io/feed.xml" title="Embedded Kiddie" />
</head>
<body>
<header class="site-header" role="banner">
  <div class="wrapper">
<a class="site-title" rel="author" href="/">Embedded Kiddie</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger">
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewbox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
            </svg>
          </span>
        </label>
        <div class="trigger">
<a class="page-link" href="/about/">About</a><a class="page-link" href="/privacy/">プライバシーポリシー</a>
</div>
      </nav>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Arduino UNO R4用バックグラウンドミュージック再生ライブラリの紹介</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-04-12T13:02:37+09:00" itemprop="datePublished">Apr 12, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>BGM 再生といっても <a href="https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/" title="tone() - Arduino Reference"><code class="language-plaintext highlighter-rouge">tone()</code></a> のことです、悪しからず。</p>

<p>あまり実用的な使い道は思いつかないですが、折角作ったので PR しちゃいます。興味のある方は「<a href="/2024/04/04/arduino-blink-with-bgm.html" title="Lチカしながら音楽再生・Arduino UNO R4のタイマと割り込みとクロック事情">Lチカしながら音楽再生・Arduino UNO R4のタイマと割り込みとクロック事情</a>」に貼った動画を見てくれれば喜びます <img class="emoji" title=":grin:" alt=":grin:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f601.png" height="20" width="20"></p>

<h2 id="backgroundmusicr4-の特徴">BackgroundMusicR4 の特徴</h2>
<p>仕組みは至って簡単。<a href="https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/" title="tone() - Arduino Reference"><code class="language-plaintext highlighter-rouge">tone()</code></a> とセットで使われる <a href="https://www.arduino.cc/reference/en/language/functions/time/delay/" title="delay() - Arduino Reference"><code class="language-plaintext highlighter-rouge">delay()</code></a> の代わりに <a href="/2024/04/09/arduino-r4-callback-timer.html" title="BGM再生用に作成したArduino UNO R4用タイマライブラリの解説 - Embedded Kiddie">前回紹介した</a>   <a href="https://github.com/embedded-kiddie/CallbackTimerR4" title="embedded-kiddie/CallbackTimerR4: Arduino UNO R4 timer library using FspTimer class."><code class="language-plaintext highlighter-rouge">CallbackTimerR4</code></a> で音符の長さだけ待機しながら、次々に音符を再生します。従来 <a href="https://docs.arduino.cc/built-in-examples/digital/toneMelody/" title="Play a Melody using the tone() function">チュートリアル</a> に記載のスケッチ例では演奏出来なかった<span class="inline"><img src="/images/2024/04-04/tie-quater-16th.png" width="74" height="27" title="4分音符＋16分音符" alt="4分音符＋16分音符"></span>や<span class="inline"><img src="/images/2024/04-10/triplet.png" width="73" height="27" title="３連符" alt="３連符"></span>といった音符も再現できるので、レパートリーの幅がグッと広がります！</p>

<div style="text-align:center">
<iframe width="560" height="315" src="https://www.youtube.com/embed/aiFlphyITyA?si=c54WeBl1vK9CJNUX" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</div>

<h2 id="インストール方法">インストール方法</h2>
<h3 id="callbacktimerr4-のインストール">CallbackTimerR4 のインストール</h3>
<p>ベースとしてタイマ系ライブラリ <a href="https://github.com/embedded-kiddie/CallbackTimerR4" title="embedded-kiddie/CallbackTimerR4: Arduino UNO R4 timer library using FspTimer class."><code class="language-plaintext highlighter-rouge">CallbackTimerR4</code></a> が必要です。<a href="/2024/04/09/arduino-r4-callback-timer.html#%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E6%96%B9%E6%B3%95" title="BGM再生用に作成したArduino UNO R4用タイマライブラリの解説 - Embedded Kiddie">コチラ</a> を参照の上、インストールしてください。</p>

<h3 id="backgroundmusicr4-のインストール">BackgroundMusicR4 のインストール</h3>
<figure class="float-left">
  <a href="/images/2024/04-10/download-library.jpg" title="CallbackTimerR4-main.zipのダウンロード" data-lightbox="image">
    <img src="/images/2024/04-10/download-library-small.jpg" width="457" height="276" alt="CallbackTimerR4-main.zipのダウンロード">
  </a>
  <a href="/images/2024/04-09/include-library.jpg" title="スケッチ → ライブラリをインクルード → .ZIP形式のライブラリをインストール…" data-lightbox="image">
    <img src="/images/2024/04-09/include-library-small.jpg" width="459" height="205" alt="スケッチ → ライブラリをインクルード → .ZIP形式のライブラリをインストール…">
  </a>
</figure>

<p><a href="https://github.com/embedded-kiddie/BackgroundMusicR4" title="embedded-kiddie/BackgroundMusicR4: Arduino background music player with tone using CallbackTimerR4 library.">Github の BackgroundMusicR4 リポジトリ</a> から画面右側にある <strong>Releases</strong> をたどり、移動先のページから最新版の <a href="https://github.com/embedded-kiddie/BackgroundMusicR4/archive/refs/tags/v1.0.0.zip" title="Release First release. · embedded-kiddie/BackgroundMusicR4"><span class="inline"><img src="/images/2024/04-09/download-zip.png" width="40.5" height="27" alt="zip ファイル">Source code (zip)</span></a> をダウンロードします。</p>

<p>続いて Arduino IDE メニューの「<strong>スケッチ</strong> → <strong>ライブラリをインクルード</strong> → <strong>.ZIP形式のライブラリをインストール…</strong>」から、先にダウンロードした .zip ファイルを読み込ませれば、ライブラリフォルダにインストールされます。</p>

<h2 id="使い方">使い方</h2>
<h3 id="スケッチのサンプル">スケッチのサンプル</h3>
<p>ライブラリのインストール後、IDE メニューの「<strong>ファイル</strong> → <strong>スケッチ例</strong> → <strong>カスタムライブラリのスケッチ例</strong>」から、曲を再生しながら Lチカする <a href="https://github.com/embedded-kiddie/BackgroundMusicR4/tree/main/examples/blink_and_music" title="BackgroundMusicR4/examples/blink_and_music at main · embedded-kiddie/BackgroundMusicR4"><code class="language-plaintext highlighter-rouge">blink_and_music</code></a> を開くことができます。添付の曲は <a href="https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B9%E3%83%AA%E3%83%BC%E3%83%96%E3%82%B9" title="グリーンスリーブス - Wikipedia">イングランド民謡</a> の <a href="https://github.com/robsoncouto/arduino-songs/tree/master/greensleeves" title="arduino-songs/greensleeves at master · robsoncouto/arduino-songs">Greensleeves</a> です。</p>

<p><code class="language-plaintext highlighter-rouge">Arduino.h</code> に続けて <code class="language-plaintext highlighter-rouge">BGMusic.h</code> をインクルードすれば <code class="language-plaintext highlighter-rouge">CBTimer.h</code> も読み込みます。</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#include</span> <span class="cpf">"Arduino.h"</span><span class="cp">
#include</span> <span class="cpf">"BGMusic.h"</span><span class="cp">
</span>
<span class="c1">// pitch and duration pairs in the melody:</span>
<span class="c1">// duration: 4 = quarter note, 8 = eighth note, etc.</span>
<span class="cp">#include</span> <span class="cpf">"pitches.h"</span><span class="cp">
</span><span class="k">static</span> <span class="kt">int</span> <span class="n">melody</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">// Special thanks for the memody data from: https://github.com/robsoncouto/arduino-songs</span>
<span class="cp">#include</span> <span class="cpf">"Greensleeves.h"</span><span class="cp">
</span><span class="p">};</span>

<span class="cp">#define BUZZER_PIN  9     // pin number connected to the buzzer
#define TEMPO       70    // change this to make the song slower or faster
#define REPEAT      true  // playback repeatedly
#define N_NOTES(s)  (sizeof(s) / sizeof((s)[0]) / 2)  // number of notes in musical score.
</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// initialize digital pin LED_BUILTIN as an output.</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">BUZZER_PIN</span><span class="p">,</span>  <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">LED_BUILTIN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>

  <span class="c1">// initialize and start the BGM player</span>
  <span class="k">static</span> <span class="n">BGMusic</span> <span class="n">music</span><span class="p">;</span>
  <span class="n">music</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">BUZZER_PIN</span><span class="p">,</span> <span class="n">melody</span><span class="p">,</span> <span class="n">N_NOTES</span><span class="p">(</span><span class="n">melody</span><span class="p">),</span> <span class="n">TEMPO</span><span class="p">,</span> <span class="n">REPEAT</span><span class="p">);</span>
  <span class="n">music</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// blink LED</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED_BUILTIN</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>  <span class="c1">// turn the LED on (HIGH is the voltage level)</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                      <span class="c1">// wait for a second</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">LED_BUILTIN</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>   <span class="c1">// turn the LED off by making the voltage LOW</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                      <span class="c1">// wait for a second</span>
<span class="p">}</span></code></pre></figure>

<p>公式の <a href="https://docs.arduino.cc/built-in-examples/digital/toneMelody/" title="Play a Melody using the tone() function">チュートリアル</a> と少し違うのは、音符と音符長のデータを１つの <code class="language-plaintext highlighter-rouge">int</code> 型配列にフラットに格納しているところで、<a href="https://github.com/robsoncouto/arduino-songs" title="robsoncouto/arduino-songs">Robson Couto さん</a> のアイディアです。音符を定義した <a href="https://github.com/embedded-kiddie/BackgroundMusicR4/blob/main/examples/blink_and_music/Greensleeves.h" title="BackgroundMusicR4/examples/blink_and_music/Greensleeves.h at main · embedded-kiddie/BackgroundMusicR4"><code class="language-plaintext highlighter-rouge">Greensleeves.h</code></a> の中身はザッとこんな感じです。</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++">  <span class="n">NOTE_G4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
  <span class="n">NOTE_AS4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">NOTE_C5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_D5</span><span class="p">,</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_DS5</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">NOTE_D5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
  <span class="n">NOTE_C5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">NOTE_A4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_F4</span><span class="p">,</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_G4</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">NOTE_A4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
  <span class="n">NOTE_AS4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">NOTE_G4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_G4</span><span class="p">,</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_FS4</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span> <span class="n">NOTE_G4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
  <span class="n">NOTE_A4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">NOTE_FS4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span> <span class="n">NOTE_D4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="n">NOTE_G4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
  <span class="p">...</span></code></pre></figure>

<p>ヘッダファイルとしてはイレギュラーですが、Arduino IDE が <code class="language-plaintext highlighter-rouge">.txt</code> とか <code class="language-plaintext highlighter-rouge">.dat</code> とかの拡張子を許してくれず、仕方なく <code class="language-plaintext highlighter-rouge">.h</code> としています。当然、この楽譜データを差し替えれば色々な曲に対応できます。</p>

<h3 id="メンバ関数の説明">メンバ関数の説明</h3>
<h4 id="コンストラクタデストラクタ">コンストラクタ／デストラクタ</h4>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">BGMusic</span> <span class="err">変数名</span><span class="p">;</span></code></pre></figure>

<p>コンストラクタは特に何もしていません。一方、デストラクタは 依存するライブラリ <a href="https://github.com/embedded-kiddie/CallbackTimerR4" title="embedded-kiddie/CallbackTimerR4: Arduino UNO R4 timer library using FspTimer class."><code class="language-plaintext highlighter-rouge">CallbackTimerR4</code></a> の <a href="/2024/04/09/arduino-r4-callback-timer.html#%E9%96%8B%E5%A7%8B%E5%81%9C%E6%AD%A2%E7%B5%82%E4%BA%86" title="BGM再生用に作成したArduino UNO R4用タイマライブラリの解説 - Embedded Kiddie"><code class="language-plaintext highlighter-rouge">end()</code></a> を呼び出して後始末をします。</p>

<p>例えば上記 <a href="#%E3%82%B9%E3%82%B1%E3%83%83%E3%83%81%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB">スケッチのサンプル</a> で、変数 <code class="language-plaintext highlighter-rouge">music</code> を <code class="language-plaintext highlighter-rouge">static</code> に確保するか、<code class="language-plaintext highlighter-rouge">setup()</code> の外でグローバル変数化しないと音が鳴らなくなるので要注意です。</p>

<p>また <a href="/2024/04/09/arduino-r4-callback-timer.html#%E3%82%B3%E3%83%B3%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF%E3%83%87%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%82%BF" title="BGM再生用に作成したArduino UNO R4用タイマライブラリの解説 - Embedded Kiddie"><code class="language-plaintext highlighter-rouge">CallbackTimerR4</code> の都合により</a>、残念ながら次のように複数の変数を宣言しても一方しか動作しません。</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="n">BGMusic</span> <span class="err">変数名１</span><span class="p">,</span> <span class="err">変数名２</span><span class="p">;</span> <span class="c1">// 変数名１と変数名２でFspTimerのインスタンスが共通となってしまう</span></code></pre></figure>

<h4 id="初期化">初期化</h4>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">bool</span> <span class="nf">begin</span><span class="p">(</span><span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">notes</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">n_notes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tempo</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">loop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">start</span> <span class="o">=</span> <span class="nb">false</span><span class="p">);</span></code></pre></figure>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int pin</code><br>
ブザー（自励式、ピエゾタイプ）など <code class="language-plaintext highlighter-rouge">tone()</code> の出力ピンを指定します。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">const int notes[]</code><br>
音符の周波数と長さを並べた <code class="language-plaintext highlighter-rouge">int</code> 型の配列を指定します。配列の中身は変更されることがない想定のため、<code class="language-plaintext highlighter-rouge">const</code> 修飾子を付けて宣言してください。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int n_notes</code><br>
音符の周波数と長さを１組と数えた時の総数を指定します。<a href="#%E3%82%B9%E3%82%B1%E3%83%83%E3%83%81%E3%81%AE%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB">スケッチのサンプル</a> にあるマクロ <code class="language-plaintext highlighter-rouge">N_NOTES()</code> を使うと楽チンです。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">int tempo</code><br>
<a href="https://ja.wikipedia.org/wiki/%E3%83%86%E3%83%B3%E3%83%9D#%E3%83%A1%E3%83%88%E3%83%AD%E3%83%8E%E3%83%BC%E3%83%A0%E8%A8%98%E5%8F%B7" title="テンポ - Wikipedia">メトロノーム記号</a> で表される曲の速さを指定します。例えば<span class="inline"><img src="/images/2024/04-04/tempo-155.png" width="60" height="27" title="テンポ=155" alt="テンポ=155"></span> は「４分音符を１分間に 155 回刻む速さ」を表します。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bool loop</code><br>
<code class="language-plaintext highlighter-rouge">true</code> を指定すると曲の終了後、直ちに再生を繰り返します。<code class="language-plaintext highlighter-rouge">false</code> が省略時のデフォルトです。</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">bool start</code><br>
<code class="language-plaintext highlighter-rouge">true</code> を指定すると初期化後、直ちに再生を開始します。省略時は <code class="language-plaintext highlighter-rouge">false</code> がデフォルトなので、別途 <code class="language-plaintext highlighter-rouge">start()</code> で再生を開始する必要があります。</p>
  </li>
</ul>

<h4 id="開始停止終了のメソッド">開始、停止、終了のメソッド</h4>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">bool</span> <span class="nf">start</span><span class="p">();</span>
<span class="kt">bool</span> <span class="nf">stop</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">end</span><span class="p">();</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">start()</code> は曲の再生を開始、<code class="language-plaintext highlighter-rouge">stop()</code> は停止です。<code class="language-plaintext highlighter-rouge">end()</code> は確保していたリソースを解放します。</p>

<h4 id="音符長計算関数の登録">音符長計算関数の登録</h4>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">void</span> <span class="n">set_duration_function</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">calc_duration_function</span><span class="p">)(</span><span class="kt">int</span> <span class="n">duration</span><span class="p">))</span></code></pre></figure>

<p>音符長をミリ秒単位で返す関数を登録する関数ですが、少々ややこしいので <a href="#%E9%9F%B3%E7%AC%A6%E9%95%B7%E8%A8%88%E7%AE%97%E9%96%A2%E6%95%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">後述</a> することにします <img class="emoji" title=":sweat_smile:" alt=":sweat_smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png" height="20" width="20">。</p>

<h2 id="曲のテンポと音符長の関係">曲のテンポと音符長の関係</h2>
<p><a href="https://www.sii.co.jp/music/try/metronome/01.html" title="やってみよう・メトロノーム記号の読み方｜メトロノーム／チューナー｜セイコーインスツル株式会社">このページ</a> を参考にまとめると、テンポと音符長の関係は次の様になります。</p>

<ul>
  <li>曲のテンポは、１分間に刻むことができる４分音符の拍数で表す</li>
  <li>例えば <span class="inline"><img src="/images/2024/04-10/quarter-note.png" width="22" height="27" title="４分音符" alt="４分音符"></span>= 60 は、１分間に４分音符を60回を数える速さを表す</li>
</ul>

<p>このテンポと４分音符一拍分の長さ（時間）を式で表すと以下となります。</p>

<p><span class="inline"><img src="/images/2024/04-10/quarter-note-duration.png" width="768" height="75" style="height:auto" alt="４分音符一拍分の長さ（時間）"></span></p>

<p>これを <a href="https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/" title="tone() - Arduino Reference"><code class="language-plaintext highlighter-rouge">tone()</code></a> の <a href="https://docs.arduino.cc/built-in-examples/digital/toneMelody/" title="Play a Melody using the tone() function">チュートリアル</a> に当てはめると、４分音符の長さを数値 <code class="language-plaintext highlighter-rouge">4</code> で表し、その時間を <code class="language-plaintext highlighter-rouge">1000 ÷ 4 = 250[msec]</code> としているので、１分間のテンポ数に換算すると <code class="language-plaintext highlighter-rouge">60000 ÷ 250 = 240</code>、つまり<span class="inline"><img src="/images/2024/04-10/quarter-note.png" width="22" height="27" title="４分音符" alt="４分音符"></span>= 240 ということになります。</p>

<p>そこで音の長さを表す数値を<span class="inline"><img src="/images/2024/04-10/n.png" width="27" height="27" alt="n"></span>、テンポを<span class="inline"><img src="/images/2024/04-10/quarter-note.png" width="22" height="27" title="４分音符" alt="４分音符"></span>=<span class="inline"><img src="/images/2024/04-10/tempo.png" width="51" height="27" alt="tempo"></span> とすると、音符の長さ（時間）を求める式は<span class="inline"><img src="/images/2024/04-10/duration-equation.png" width="149" height="63" style="height:3.5em" alt="４分音符一拍分の長さ（時間）"></span>となります。</p>

<p><a href="https://github.com/embedded-kiddie/BackgroundMusicR4" title="embedded-kiddie/BackgroundMusicR4: Arduino background music player with tone using CallbackTimerR4 library."><code class="language-plaintext highlighter-rouge">BackgroundMusicR4</code></a> では互換性を考慮し、この式を元に音符長を決めています。</p>

<h2 id="音符長計算関数について">音符長計算関数について</h2>
<p>一方、上記方式の問題点は、「・」のついた付点音符（元の音符の1.5倍の長さ）や、4分音符＋16分音符を表す<span class="inline"><img src="/images/2024/04-04/tie-quater-16th.png" width="74" height="27" title="4分音符＋16分音符" alt="4分音符＋16分音符"></span>などの音符長が整数で表せないことです。</p>

<p><code class="language-plaintext highlighter-rouge">float</code> を使えばデータサイズこそ <code class="language-plaintext highlighter-rouge">int</code> と同じになりますが、浮動小数点演算が必要になります。UNO R4 のマイコンは FPU を持っているので実際にはそれほど問題にならないかも知れませんが、できれば整数演算で済ませたいところです。</p>

<p>ということで「音符長計算関数」の登場です。</p>

<h3 id="音符長の計算式">音符長の計算式</h3>
<p>まずは <a href="https://docs.arduino.cc/built-in-examples/digital/toneMelody/" title="Play a Melody using the tone() function">チュートリアル</a> の音符長表現のおさらいです。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">N分音符</th>
      <th style="text-align: center">16分音符</th>
      <th style="text-align: center">8分音符</th>
      <th style="text-align: center">4分音符</th>
      <th style="text-align: center">2分音符</th>
      <th style="text-align: center">全音符</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">音符長</td>
      <td style="text-align: center">16</td>
      <td style="text-align: center">8</td>
      <td style="text-align: center">4</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">1</td>
    </tr>
  </tbody>
</table>

<p>直感的な分かり易さを優先させたのだと思いますが、短い音符ほど音符長を表す数値が大きくなってます。</p>

<p>これに対し、４分音符一拍分の長さ <code class="language-plaintext highlighter-rouge">4</code> を基準に（ここまでは（<a href="https://docs.arduino.cc/built-in-examples/digital/toneMelody/" title="Play a Melody using the tone() function">チュートリアル</a> と同じ）、各音符の長さの比と、それを表すシンボルを割り当ててみます。直感的な分かり易さはそのままに、数値ではなく <code class="language-plaintext highlighter-rouge">N4</code> などのシンボルを使う様にするワケです。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">N分音符</th>
      <th style="text-align: center">16分音符</th>
      <th style="text-align: center">8分音符</th>
      <th style="text-align: center">4分音符</th>
      <th style="text-align: center">2分音符</th>
      <th style="text-align: center">全音符</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">音符長比 <span class="inline"><img src="/images/2024/04-10/n.png" width="27" height="27" alt="n"></span>
</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">4</td>
      <td style="text-align: center">8</td>
      <td style="text-align: center">16</td>
    </tr>
    <tr>
      <td style="text-align: left">シンボル</td>
      <td style="text-align: center">N16</td>
      <td style="text-align: center">N8</td>
      <td style="text-align: center">N4</td>
      <td style="text-align: center">N2</td>
      <td style="text-align: center">N1</td>
    </tr>
  </tbody>
</table>

<p>ここで N 分音符の音符長比を表す数値を<span class="inline"><img src="/images/2024/04-10/n.png" width="27" height="27" alt="n"></span>、曲の速さを<span class="inline"><img src="/images/2024/04-10/tempo.png" width="51" height="27" alt="テンポ"></span>とすれば、音の長さ（時間）を求める式は<span class="inline"><img src="/images/2024/04-10/duration_equation-new.png" width="173" height="45" style="height:2.5em" alt="４分音符一拍分の長さ（時間）"></span>となります。</p>

<p>この方式であれば、4分音符と16分音符を <a href="https://ja.wikipedia.org/wiki/%E3%82%BF%E3%82%A4_(%E9%9F%B3%E6%A5%BD%E8%A8%98%E5%8F%B7)" title="タイ (音楽記号) - Wikipedia">タイ</a> で１つに繋げた<span class="inline"><img src="/images/2024/04-04/tie-quater-16th.png" width="74" height="27" title="4分音符＋16分音符" alt="4分音符＋16分音符"></span>の音符長は整数演算が可能な <code class="language-plaintext highlighter-rouge">N4 + N16</code>、即ち <code class="language-plaintext highlighter-rouge">5</code> で表せることになります。</p>

<p>また４分音符一拍中に３音を鳴らす３連符（Triplet）<span class="inline"><img src="/images/2024/04-10/triplet.png" width="73" height="27" title="３連符" alt="３連符"></span>も怖くありません。音符長比をそれぞれ３倍したシンボルを定義すれば良いだけです。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">N分音符</th>
      <th style="text-align: center">16分音符</th>
      <th style="text-align: center">3連符</th>
      <th style="text-align: center">8分音符</th>
      <th style="text-align: center">4分音符</th>
      <th style="text-align: center">2分音符</th>
      <th style="text-align: center">全音符</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">音符長比<span class="inline"><img src="/images/2024/04-10/n.png" width="27" height="27" alt="n"></span>
</td>
      <td style="text-align: center">1 × 3 = 3</td>
      <td style="text-align: center">4</td>
      <td style="text-align: center">2 × 3 = 6</td>
      <td style="text-align: center">4 × 3 = 12</td>
      <td style="text-align: center">8 × 3 = 24</td>
      <td style="text-align: center">16 × 3 = 48</td>
    </tr>
    <tr>
      <td style="text-align: left">シンボル</td>
      <td style="text-align: center">N16</td>
      <td style="text-align: center">NT</td>
      <td style="text-align: center">N8</td>
      <td style="text-align: center">N4</td>
      <td style="text-align: center">N2</td>
      <td style="text-align: center">N1</td>
    </tr>
  </tbody>
</table>

<p>これで再現できる曲がグッと増えること間違いなしです！</p>

<h3 id="音符長計算関数の登録-1">音符長計算関数の登録</h3>
<p>ということで、前述のメンバ関数 <code class="language-plaintext highlighter-rouge">set_duration_function()</code> は以下の様に使います。</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#define BUZZER_PIN    9     // pin number connected to the buzzer
#define TEMPO         155   // change this to make the song slower or faster
#define REPEAT        true  // playback repeatedly
#define N_NOTES(s)    (sizeof(s) / sizeof((s)[0]) / 2)  // number of notes in musical score.
#define QUARTER_NOTE  ((60000 / N4) / TEMPO)  // ratio of the duration for one quarter note per beat
</span>
<span class="c1">// Calculate note length from note length symbol</span>
<span class="kt">int</span> <span class="nf">calc_duration</span><span class="p">(</span><span class="kt">int</span> <span class="n">duration</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">QUARTER_NOTE</span> <span class="o">*</span> <span class="n">duration</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// initialize digital pin LED_BUILTIN as an output.</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">BUZZER_PIN</span><span class="p">,</span>  <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">LED_BUILTIN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>

  <span class="c1">// initialize and start the BGM player</span>
  <span class="k">static</span> <span class="n">BGMusic</span> <span class="n">music</span><span class="p">;</span>
  <span class="n">music</span><span class="p">.</span><span class="n">set_duration_function</span><span class="p">(</span><span class="n">calc_duration</span><span class="p">);</span>
  <span class="n">music</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">BUZZER_PIN</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">N_NOTES</span><span class="p">(</span><span class="n">score</span><span class="p">),</span> <span class="n">TEMPO</span><span class="p">,</span> <span class="n">REPEAT</span><span class="p">);</span>
  <span class="n">music</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">QUARTER_NOTE</code> は「４分音符一拍分当たりの長さの比率」です。<code class="language-plaintext highlighter-rouge">calc_duration()</code> に渡される <code class="language-plaintext highlighter-rouge">int duration</code> は <code class="language-plaintext highlighter-rouge">N4</code> とか <code class="language-plaintext highlighter-rouge">N8</code> とか <code class="language-plaintext highlighter-rouge">N4 + N16</code> などの値となります。</p>

<p>上記のコードは <a href="https://github.com/embedded-kiddie/Arduino-UNO-R4/tree/main/background_music" title="Arduino-UNO-R4/background_music at main · embedded-kiddie/Arduino-UNO-R4"><code class="language-plaintext highlighter-rouge">background_music</code></a> からの抜粋です。大好きな <a href="https://www.youtube.com/watch?v=FZaUPGjjA4c" title="TRUTH (LIVE) T-SQUARE - YouTube">T-SQUARE の TRUTH</a> を収録してあるので、よかったら聞いてみてください。</p>

<h2 id="あとがき">あとがき</h2>
<p>バックグラウンドで音を鳴らすだけで、<a href="https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/" title="tone() - Arduino Reference"><code class="language-plaintext highlighter-rouge">tone()</code></a> で１個、<a href="https://github.com/embedded-kiddie/CallbackTimerR4" title="embedded-kiddie/CallbackTimerR4: Arduino UNO R4 timer library using FspTimer class."><code class="language-plaintext highlighter-rouge">CallbackTimerR4</code></a> ライブラリで１個、合計２個のタイマを使っちゃてるんですよね。</p>

<p>今回はかつて <a href="https://www.nxp.jp/products/processors-and-microcontrollers/arm-microcontrollers/general-purpose-mcus/lpc1300-arm-cortex-m3/entry-level-32-bit-microcontroller-mcu-based-on-arm-cortex-m3-core:LPC1343FBD48" title="LPC1343FBD48 - Arm Cortex-M3 - 32-bit MCU - NXP Semiconductors">Cortex-M3 の LPC1343</a> ボードで作った機能（ご参考：<a href="https://github.com/embedded-kiddie/beauto-rover-arm/blob/main/src/play.c" title="beauto-rover-arm/src/play.c at main · embedded-kiddie/beauto-rover-arm"><code class="language-plaintext highlighter-rouge">play.c</code></a>）の移植を目指してきましたが、移植に際し当初２つの案がありました。</p>

<ul>
  <li>
<a href="https://github.com/arduino/ArduinoCore-renesas/blob/main/cores/arduino/Tone.cpp" title="ArduinoCore-renesas/cores/arduino/Tone.cpp at main · arduino/ArduinoCore-renesas"><code class="language-plaintext highlighter-rouge">Tone.cpp</code></a> を丸っとコピーし、そこにミュージックシーケンサ的機能を組み込む</li>
  <li>
<a href="https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/" title="tone() - Arduino Reference"><code class="language-plaintext highlighter-rouge">tone()</code></a> はそのまま活かし、ミュージックシーケンサ的機能でラップする</li>
</ul>

<p>前者であればタイマは１個で済んだハズですが、<a href="/2024/04/04/arduino-blink-with-bgm.html" title="Lチカしながら音楽再生・Arduino UNO R4のタイマと割り込みとクロック事情 - Embedded Kiddie">勉強も兼ねて</a> 後者を選びました。</p>

<p>その上での感想ですが、まず第１に Cortex-M3 のレジスタに比べ Cortex-M4 のそれは何倍も難しくなっていること、そして第２に Arduino のプログラミングはライブラリのお陰で楽な反面、うまく折り合いを付けなきゃならない（コメントの少ないコードをリーディングするという）苦労があり、なかなかに手強いぞ！と感じてます。</p>

<p>ともあれ、豊富な情報と関連モジュール（H/W、S/W）との組み合わせが Arduino を楽しむコツと分かってきた今日この頃です <img class="emoji" title=":man_shrugging:" alt=":man_shrugging:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f937-2642.png" height="20" width="20"></p>


  </div>
  <div class="wrapper pager">
    <p class="prev">
      <a href="/2024/04/09/arduino-r4-callback-timer.html" title="前の記事：BGM再生用に作成したArduino UNO R4用タイマライブラリの解説">← BGM再生用に作成したArduino UNO R4用タイマライブラリの解説</a>
    </p>

    <p class="next">
      <a href="/2024/04/14/printf-for-arduino-uno-r4.html" title="次の記事：Arduino UNO R4のデバッグ・printfの行方の謎とprintlnの小技">Arduino UNO R4のデバッグ・printfの行方の謎とprintlnの小技 →</a>
    </p>    
  </div>
<div id="disqus_thread">
<span id="disqus-comment-count" class="disqus-comment-count" data-disqus-url="https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html"></span><button id="open_disqus" class="simple" title="クリックするとコメントフォームが開きます"><img src="/images/comment-disqus.png" width="1536" height="866" alt="Disqus コメントフォーム"></button>
</div>
<a class="u-url" href="/2024/04/12/background-tone-player.html" hidden></a>
</article>

      </div>
    </main>
<footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Embedded Kiddie</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Kingsman</li>
<li><a class="u-email" href="https://mailhide.io/e/DpUPhw9C" onclick="popup=window.open('https://mailhide.io/e/DpUPhw9C','mailhidepopup','width=580,height=635'); return false;">e......@gmail.com</a></li>
</ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
<li><a href="https://github.com/embedded-kiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">embedded-kiddie</span></a></li>
<li><a href="https://www.twitter.com/EmbeddedKiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">EmbeddedKiddie</span></a></li>
<li><a href="https://youtube.com/@EmbeddedKiddie"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">EmbeddedKiddie</span></a></li>
</ul></div>

      <div class="footer-col footer-col-3">
        <p>組み込みエンジニア。かつては趣味でWordPressプラグインなどリリース。 興味をロボットや電子工作に転じ、ハードとソフトを再勉強する日々。</p>
      </div>
    </div>

  </div>
  <button id="js-pagetop" class="pagetop"><span class="pagetop_arrow"></span></button>
</footer>

<script>'use strict';(function(){const b=document.querySelector("#js-pagetop");b.addEventListener("click",c=>{function e(a){null==d&&(d=a);a-=d;var f=a/500;window.scrollTo(0,g-g*(1===f?1:-Math.pow(2,-10*f)+1));500>a?requestAnimationFrame(e):window.scroll(h)}c.stopPropagation();const h={top:0,left:0},g=window.scrollY;let d=null;window.scroll(h);requestAnimationFrame(e)});window.addEventListener("scroll",c=>{1<window.scrollY?b.classList.add("fadeIn"):b.classList.remove("fadeIn");"undefined"===typeof commentCount||commentCount.done||commentCount.show(c)});const target=document.querySelector('#disqus-comment-count');const commentCount={done:!1,show:function(e){const r=target.getBoundingClientRect();if(r.top<=window.innerHeight&&r.bottom>=0){this.done=!0;const s=document.createElement('script');s.id="dsq-count-scr";s.src="https://embedded-kiddie.disqus.com/count.js";target.appendChild(s)}}};if("embedded-kiddie.github.io"===window.location.hostname){const o=new MutationObserver(records=>{let t=target.textContent.substring(0,1);if(t+0!==0){let e=new Event('click');document.querySelector('#open_disqus').dispatchEvent(e)}});o.observe(target,{childList:!0});document.querySelector('#open_disqus').addEventListener('click',(e)=>{var disqus_config=function(){this.page.url="https://embedded-kiddie.github.io/2024/04/12/background-tone-player.html";this.page.identifier="/2024/04/12/background-tone-player.html"};const d=document,s=d.createElement('script');s.src="https://embedded-kiddie.disqus.com/embed.js";s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);o.disconnect()})}})();</script>
<script async src="https://cdn.jsdelivr.net/npm/luminous-lightbox@2.4.0/dist/luminous.min.js" integrity="sha256-4vMnmzhFzuXVxRHRFNwJzPnT923+MfWHWU4deBjd/vQ=" crossorigin="anonymous"></script>
<script async src="/assets/luminous-config.min.js"></script>
</body>
</html>